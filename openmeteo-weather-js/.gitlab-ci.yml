stages:
  - build
  - test
  - deploy

# Definiere das Docker Image (Node.js statt Maven)
image: node:20

# Variablen (analog zu Maven CLI Optionen, aber hier Node.js)
variables:
  NODE_ENV: test
  CI: "true"

# -------------------
# Build Job
# -------------------
build-job:
  stage: build
  script:
    - echo "Installing dependencies..."
    - cd server
    - npm ci
  artifacts:
    paths:
      - server/node_modules/
    expire_in: 1h

# -------------------
# Test Job
# -------------------
unit-test-job:
  stage: test
  script:
    - echo "Running Vitest with Coverage..."
    - cd server
    - npm run coverage
  artifacts:
    when: always
    paths:
      - server/coverage
    reports:
      junit: server/coverage/junit.xml
    expire_in: 1 week

# -------------------
# Deploy Job (GitLab Pages)
# -------------------
pages:
  stage: deploy
  script:
    - echo "Publishing coverage report..."
    - mv server/coverage public
  artifacts:
    paths:
      - public
  only:
    - main
